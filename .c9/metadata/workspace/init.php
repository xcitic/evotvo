{"filter":false,"title":"init.php","tooltip":"/init.php","undoManager":{"mark":0,"position":0,"stack":[[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":0,"column":0},"end":{"row":0,"column":5}},"text":"<?php"},{"action":"insertText","range":{"start":{"row":0,"column":5},"end":{"row":1,"column":0}},"text":"\n"},{"action":"insertLines","range":{"start":{"row":1,"column":0},"end":{"row":232,"column":0}},"lines":["@error_reporting(E_ERROR | E_WARNING | E_PARSE);","if(session_id() == \"\") {","\t@session_start();","}","// ---------------------------------------------------","//  Directories","// ---------------------------------------------------","define('ROOT', dirname(__FILE__));","define('PLUGIN_PATH',\t   ROOT . '/plugins' ) ;","define('APPLICATION_PATH', ROOT . '/application');","define('LIBRARY_PATH',     ROOT . '/library');","define('CACHE_DIR',        ROOT . '/cache');","define('THEMES_DIR',       ROOT . '/public/assets/themes');","","set_include_path(ROOT . PATH_SEPARATOR . APPLICATION_PATH . PATH_SEPARATOR . get_include_path());","set_include_path(LIBRARY_PATH . \"/zend\" . PATH_SEPARATOR . get_include_path());","set_include_path(LIBRARY_PATH . \"/ezcomponents\" . PATH_SEPARATOR . get_include_path());","set_include_path(LIBRARY_PATH . \"/PEAR\" . PATH_SEPARATOR . get_include_path());","set_include_path(LIBRARY_PATH . \"/pdf\" . PATH_SEPARATOR . get_include_path());","","if ((defined('LUCENE_SEARCH') && LUCENE_SEARCH)) {","\trequire_once('Zend/Search/Lucene.php');","}","","// ---------------------------------------------------","//  Fix some $_SERVER vars (taken from wordpress code)","// ---------------------------------------------------","","// Fix for IIS, which doesn't set REQUEST_URI","if(!isset($_SERVER['REQUEST_URI']) || trim($_SERVER['REQUEST_URI']) == '') {","\t$_SERVER['REQUEST_URI'] = $_SERVER['SCRIPT_NAME']; // Does this work under CGI?","","\t// Append the query string if it exists and isn't null","\tif (isset($_SERVER['QUERY_STRING']) && !empty($_SERVER['QUERY_STRING'])) {","\t\t$_SERVER['REQUEST_URI'] .= '?' . $_SERVER['QUERY_STRING'];","\t} // if","} // if","","// Fix for PHP as CGI hosts that set SCRIPT_FILENAME to something ending in php.cgi for all requests","if ( isset($_SERVER['SCRIPT_FILENAME']) && ( strpos($_SERVER['SCRIPT_FILENAME'], 'php.cgi') == strlen($_SERVER['SCRIPT_FILENAME']) - 7 ) ) {","\t$_SERVER['SCRIPT_FILENAME'] = $_SERVER['PATH_TRANSLATED'];","} // if","","// Fix for Dreamhost and other PHP as CGI hosts","if(strstr($_SERVER['SCRIPT_NAME'], 'php.cgi')) unset($_SERVER['PATH_INFO']);","","if(trim($_SERVER['PHP_SELF']) == '') $_SERVER['PHP_SELF'] = preg_replace(\"/(\\?.*)?$/\",'', $_SERVER[\"REQUEST_URI\"]);","","// ---------------------------------------------------","//  Check if script is installed","// ---------------------------------------------------","","// If script is not installed config.php will return false. Othervise it will","// return NULL. If we get false redirect to install folder","$config_is_set = @include_once(ROOT . '/config/config.php');","if(!is_bool($config_is_set) || !$config_is_set) {","\theader(\"Location: public/install\");","\tprint \"Feng Office is not installed. Please redirect your browser to <a href=\\\"\" . PUBLIC_FOLDER . \"/install\\\">\" . PUBLIC_FOLDER . \"/install</a> folder and follow installation procedure\";","\tdie();","} // if","","// ---------------------------------------------------","//  config.php + extended config","// ---------------------------------------------------","require_once(__DIR__.'/../pedadida-config.php');","","if (!defined('FILES_DIR')) define('FILES_DIR', ROOT . '/upload'); // place where we will upload project files","define('PRODUCT_NAME', $pedadida_lab_name);","define('PRODUCT_URL', $pedadida_lab_base);","define('DEFAULT_HELP_LINK', 'http://fengoffice.com/web/wiki');","","define('MAX_SEARCHABLE_FILE_SIZE', 1048576); // if file type is searchable script will load its content into search index. Using this constant you can set the max filesize of the file that will be imported. Noone wants 500MB in search index for single file","define('SESSION_LIFETIME', 7200);","define('REMEMBER_LOGIN_LIFETIME', 1209600); // two weeks","","// Defaults","define('DEFAULT_CONTROLLER', 'access');","define('DEFAULT_ACTION', 'index');","define('DEFAULT_THEME', 'default');","","define('SLIMEY_PATH', ROOT_URL . '/public/assets/javascript/slimey/');","define('PLUGINS_URL', ROOT_URL . '/plugins' ) ;","","","// ---------------------------------------------------","//  Init...","// ---------------------------------------------------","","include_once 'environment/environment.php';","","if (Env::isDebuggingTime()) {","\tTimeIt::start(\"Total\");","}","","include_once 'library/json/json.php';","","// Lets prepare everything for autoloader","require APPLICATION_PATH . '/functions.php'; // __autoload() function is defined here...","","if (!$callbacks = spl_autoload_functions()) $callbacks = array();","foreach ($callbacks as $callback) {","\tspl_autoload_unregister($callback);","}","spl_autoload_register('feng__autoload');","foreach ($callbacks as $callback) {","\tspl_autoload_register($callback);","}","","","@include CACHE_DIR . '/autoloader.php';","","// Prepare logger... We might need it early...","//if(Env::isDebugging()) {","\tLogger::setSession(new Logger_Session('default'));","\tLogger::setBackend(new Logger_Backend_File(CACHE_DIR . '/log.php'));","\t ","\tset_error_handler('__production_error_handler');","\tset_exception_handler('__production_exception_handler');","/*} else {","\tLogger::setSession(new Logger_Session('default'));","\tLogger::setBackend(new Logger_Backend_Null());","} // if*/","","register_shutdown_function('__shutdown');","","// Connect to database...","try {","\tDB::connect(DB_ADAPTER, array(","      'host'    => DB_HOST,","      'user'    => DB_USER,","      'pass'    => DB_PASS,","      'name'    => DB_NAME,","      'persist' => DB_PERSIST","\t)); // connect","\tif(defined('DB_CHARSET') && trim(DB_CHARSET)) {","\t\tDB::execute(\"SET NAMES ?\", DB_CHARSET);","\t} // if","} catch(Exception $e) {","\tif(Env::isDebugging()) {","\t\tEnv::dumpError($e);","\t} else {","\t\tLogger::log($e, Logger::FATAL);","\t\tEnv::executeAction('error', 'db_connect');","\t} // if","} // try","","// Init application","if(Env::isDebugging()) {","\tbenchmark_timer_set_marker('Init application');","} // if","","// We need to call application.php after the routing is executed because","// some of the application classes may need CONTROLLER, ACTION or $_GET","// data collected by the matched route","require_once APPLICATION_PATH . '/application.php';","if (!defined('DONT_USE_FENG_UTF8') || !DONT_USE_FENG_UTF8) {","\trequire_once LIBRARY_PATH . '/utf8/utf8.php';","}","","// Set handle request timer...","if(Env::isDebugging()) {","\tbenchmark_timer_set_marker('Handle request');","} // if","","","if(isset($_GET['a'])){","if($_GET['a'] == 'login')","{"," //ADD THIRD PARTY SO IT DOES NOT LOAD MOODLE OR WORDPRESS","$third_party = 1;","define('WP_USE_THEMES', false);","require_once(__DIR__.'/../wp-blog-header.php');","","if ( is_user_logged_in() ) {","   $current_user = wp_get_current_user(); ","","   $sql = \"SELECT object_id  FROM fo_contacts WHERE username = '$current_user->user_login'\";","   $results = $wpdb->get_results($sql) or die(mysql_error());","","    foreach( $results as $result ) {","        $feng_id = $result->object_id;","    }","\t","\t   ","\t$_SESSION[\"id\"] = $feng_id;","\tajx_current(\"empty\");","\t$user = Contacts::getByUsername($current_user->user_login, owner_company());","","\t\t\ttry {","\t\t\t\tCompanyWebsite::instance()->logUserIn($user, 0);","\t\t\t} catch(Exception $e) {","\t\t\t\tflash_error(lang('invalid login data'));","\t\t\t\treturn;","\t\t\t} // try","} ","else {","\t$actual_link = site_url( '/lab/ ' );","    wp_redirect( wp_login_url( $actual_link  )  );","}","","}}","","// Remove injection from url parameters","foreach($_GET as $k => &$v) {","\t$v = remove_css_and_scripts($v);","}","","// Get controller and action and execute...","try {","\tif (!defined( 'CONSOLE_MODE' )) {","\t\tEnv::executeAction(request_controller(), request_action()) ;","\t}","} catch(Exception $e) {","\tif(Env::isDebugging()) {","\t\tLogger::log($e, Logger::FATAL);","\t\tEnv::dumpError($e);","\t} else {","\t\tLogger::log($e, Logger::FATAL);","\t\tredirect_to(get_url('error', 'execute_action'));","\t} // if","} // try","","if (Env::isDebuggingTime()) {","\tTimeIt::stop();","\tif (array_var($_REQUEST, 'a') != 'popup_reminders') {","\t\t$report = TimeIt::getTimeReportByType();","\t\t$report .= \"\\nMemory Usage: \" . format_filesize(memory_get_usage(true));","\t\tfile_put_contents('cache/log.time', \"Request: \".print_r($_REQUEST,1).\"\\nTime Report:\\n------------\\n$report\\n--------------------------------------\\n\", FILE_APPEND);","\t}","}",""]},{"action":"insertText","range":{"start":{"row":232,"column":0},"end":{"row":232,"column":2}},"text":"?>"}]}]]},"ace":{"folds":[],"scrolltop":2478,"scrollleft":0,"selection":{"start":{"row":232,"column":2},"end":{"row":232,"column":2},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":176,"state":"php-start","mode":"ace/mode/php"}},"timestamp":1413165033235,"hash":"fb28506498e523412ea92fb6a958797d10829358"}